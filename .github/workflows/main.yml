name: Testing
on:
  - push
  - workflow_dispatch

jobs:
  job:
    runs-on: ubuntu-latest
    name: job
    steps:
      - name: Checkout 
        uses: actions/checkout@v2
        with:
          submodules: recursive
      - name: Build Docker
        uses: docker/build-push-action@v2
        with:
          push: false
          tags: arch-test:latest
          build-args: |
                      PACKAGES=gcc cmake ninja clang
      - name: Move existing build directory
        uses: addnab/docker-run-action@v3
        with:
          image: arch-test:latest
          options: -v ${{ github.workspace }}:/workspace
          run: mv /workspace/build /workspace/.build 2> /dev/null || true
      - name: CMake
        uses: addnab/docker-run-action@v3
        with:
          image: arch-test:latest
          options: -v ${{ github.workspace }}:/workspace
          run: cmake -DCMAKE_BUILD_TYPE:STRING=Release -S /workspace/ -B /workspace/build/ -G Ninja
      - name: Build tests
        uses: addnab/docker-run-action@v3
        with:
          image: arch-test:latest
          options: -v ${{ github.workspace }}:/workspace
          run: cmake --build /workspace/build/ --config Release --target PP-tests -j 10 --
      - name: Run tests
        uses: addnab/docker-run-action@v3
        with:
          image: arch-test:latest
          options: -v ${{ github.workspace }}:/workspace
          run: ctest --test-dir /workspace/build/ -C Release -T test --output-on-failure
      - name: Move build directory back
        uses: addnab/docker-run-action@v3
        with:
          image: arch-test:latest
          options: -v ${{ github.workspace }}:/workspace
          run: rm -r /workspace/build; mv /workspace/.build /workspace/build 2> /dev/null || true
